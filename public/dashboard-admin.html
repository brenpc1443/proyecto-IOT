<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reportes - Estacionamiento Inteligente</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2332 0%, #2d3e50 100%);
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header h1 {
      font-size: 2rem;
      color: #333;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .filters {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .filters input, .filters select {
      padding: 0.8rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: border-color 0.3s;
    }

    .filters input:focus, .filters select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .btn {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
    }

    .btn-pdf {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
    }

    .btn-pdf:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(220, 38, 38, 0.3);
    }

    .btn-csv {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      color: white;
    }

    .btn-csv:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(5, 150, 105, 0.3);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-left: 5px solid;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
    }

    .stat-card.success { border-left-color: #10b981; }
    .stat-card.primary { border-left-color: #2563eb; }
    .stat-card.warning { border-left-color: #f59e0b; }
    .stat-card.danger { border-left-color: #ef4444; }

    .stat-label {
      font-size: 0.85rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #333;
    }

    .stat-subtitle {
      font-size: 0.8rem;
      color: #999;
      margin-top: 0.5rem;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .chart-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .chart-card h3 {
      margin-bottom: 1rem;
      color: #333;
      font-size: 1.1rem;
    }

    .table-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    .table-card h3 {
      margin-bottom: 1rem;
      color: #333;
      font-size: 1.1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      color: white;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid #e0e0e0;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-pagada {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-pendiente {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-activa {
      background: #e0e7ff;
      color: #3730a3;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #999;
    }

    .empty-state img {
      width: 100px;
      opacity: 0.5;
      margin-bottom: 1rem;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #999;
    }

    .spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid #e0e0e0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* PDF Styles */
    .pdf-content {
      background: white;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
    }

    @media print {
      body {
        background: white;
        padding: 0;
      }
      .header, .filters, .btn {
        display: none;
      }
      .stats-grid, .charts-grid, .table-card {
        page-break-inside: avoid;
      }
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>游늵 Reportes de Estacionamiento</h1>
      <div class="filters">
        <input type="date" id="fechaInicio">
        <input type="date" id="fechaFin">
        <button class="btn btn-primary" onclick="generarReporte()">Generar Reporte</button>
        <div class="action-buttons">
          <button class="btn btn-pdf" onclick="descargarPDF()">游닌 Descargar PDF</button>
          <button class="btn btn-csv" onclick="descargarCSV()">游늵 Exportar CSV</button>
        </div>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card primary">
        <div class="stat-label">Total Sesiones</div>
        <div class="stat-value" id="statTotalSesiones">0</div>
        <div class="stat-subtitle">en el per칤odo seleccionado</div>
      </div>
      <div class="stat-card success">
        <div class="stat-label">Sesiones Pagadas</div>
        <div class="stat-value" id="statPagadas">0</div>
        <div class="stat-subtitle">completadas y pagadas</div>
      </div>
      <div class="stat-card warning">
        <div class="stat-label">Pendientes de Pago</div>
        <div class="stat-value" id="statPendientes">0</div>
        <div class="stat-subtitle">esperando confirmaci칩n</div>
      </div>
      <div class="stat-card success">
        <div class="stat-label">Ingresos Totales</div>
        <div class="stat-value" id="statIngresos">S/ 0.00</div>
        <div class="stat-subtitle">capital recaudado</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3>游늳 Ingresos por Turno</h3>
        <canvas id="chartIngresos"></canvas>
      </div>
      <div class="chart-card">
        <h3>游댃 Distribuci칩n de Sesiones</h3>
        <canvas id="chartDistribucion"></canvas>
      </div>
    </div>

    <!-- Table -->
    <div class="table-card">
      <h3>游늶 Detalle de Sesiones</h3>
      <div class="table-container">
        <table id="reporteTable">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Turno</th>
              <th>Sesiones</th>
              <th>Pagadas</th>
              <th>Pendientes</th>
              <th>Activas</th>
              <th>Ingresos Pagados</th>
              <th>Ingresos Pendientes</th>
              <th>Tiempo Promedio</th>
            </tr>
          </thead>
          <tbody id="reporteBody">
            <tr><td colspan="9" class="loading"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- PDF Hidden Content -->
    <div id="pdfContent" style="display: none;">
      <div class="pdf-content" id="pdfBody"></div>
    </div>
  </div>

  <script>
    let datosReporte = [];
    let chartIngresos = null;
    let chartDistribucion = null;

    // Set default dates
    window.addEventListener('DOMContentLoaded', () => {
      const hoy = new Date();
      const hace30 = new Date(hoy.getTime() - 30 * 24 * 60 * 60 * 1000);
      
      document.getElementById('fechaInicio').valueAsDate = hace30;
      document.getElementById('fechaFin').valueAsDate = hoy;
      
      generarReporte();
    });

    async function generarReporte() {
      const inicio = document.getElementById('fechaInicio').value;
      const fin = document.getElementById('fechaFin').value;

      if (!inicio || !fin) {
        alert('Por favor selecciona ambas fechas');
        return;
      }

      try {
        // Simular datos (en producci칩n vendr칤an del API)
        datosReporte = await obtenerReporte(inicio, fin);
        renderizarDatos();
        actualizarGraficos();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al generar reporte');
      }
    }

    async function obtenerReporte(inicio, fin) {
      // Datos simulados - reemplazar con llamada real al API
      const datos = [];
      const fechaInicio = new Date(inicio);
      const fechaFin = new Date(fin);
      
      for (let d = new Date(fechaInicio); d <= fechaFin; d.setDate(d.getDate() + 1)) {
        datos.push(
          {
            fecha: d.toISOString().split('T')[0],
            nombre_turno: 'ma침ana',
            total_sesiones: Math.floor(Math.random() * 20) + 5,
            pagadas: Math.floor(Math.random() * 18) + 3,
            pendientes: Math.floor(Math.random() * 5),
            activas: Math.floor(Math.random() * 3),
            ingresos_pagados: Math.random() * 500 + 100,
            ingresos_pendientes: Math.random() * 200,
            tiempo_promedio: Math.floor(Math.random() * 120) + 30
          },
          {
            fecha: d.toISOString().split('T')[0],
            nombre_turno: 'tarde',
            total_sesiones: Math.floor(Math.random() * 25) + 8,
            pagadas: Math.floor(Math.random() * 22) + 5,
            pendientes: Math.floor(Math.random() * 6),
            activas: Math.floor(Math.random() * 2),
            ingresos_pagados: Math.random() * 600 + 150,
            ingresos_pendientes: Math.random() * 250,
            tiempo_promedio: Math.floor(Math.random() * 140) + 40
          }
        );
      }
      return datos;
    }

    function renderizarDatos() {
      if (datosReporte.length === 0) {
        document.getElementById('reporteBody').innerHTML = 
          '<tr><td colspan="9" class="empty-state">No hay datos para este per칤odo</td></tr>';
        return;
      }

      // Calcular totales
      let totalSesiones = 0, totalPagadas = 0, totalPendientes = 0, totalIngresos = 0;
      
      datosReporte.forEach(r => {
        totalSesiones += r.total_sesiones;
        totalPagadas += r.pagadas;
        totalPendientes += r.pendientes;
        totalIngresos += r.ingresos_pagados;
      });

      // Actualizar stats
      document.getElementById('statTotalSesiones').textContent = totalSesiones;
      document.getElementById('statPagadas').textContent = totalPagadas;
      document.getElementById('statPendientes').textContent = totalPendientes;
      document.getElementById('statIngresos').textContent = `S/ ${totalIngresos.toFixed(2)}`;

      // Renderizar tabla
      const tbody = document.getElementById('reporteBody');
      tbody.innerHTML = datosReporte.map(r => `
        <tr>
          <td><strong>${r.fecha}</strong></td>
          <td><span style="text-transform: capitalize;">${r.nombre_turno}</span></td>
          <td>${r.total_sesiones}</td>
          <td><span class="badge badge-pagada">${r.pagadas}</span></td>
          <td><span class="badge badge-pendiente">${r.pendientes}</span></td>
          <td><span class="badge badge-activa">${r.activas}</span></td>
          <td><strong>S/ ${r.ingresos_pagados.toFixed(2)}</strong></td>
          <td><strong>S/ ${r.ingresos_pendientes.toFixed(2)}</strong></td>
          <td><span style="background: #f0f9ff; color: #075985; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600;">${Math.round(r.tiempo_promedio)} min</span></td>
        </tr>
      `).join('');
    }

    function actualizarGraficos() {
      // Agrupar por turno
      const turnoData = {};
      datosReporte.forEach(r => {
        if (!turnoData[r.nombre_turno]) {
          turnoData[r.nombre_turno] = { ingresos: 0, sesiones: 0, pagadas: 0, pendientes: 0 };
        }
        turnoData[r.nombre_turno].ingresos += r.ingresos_pagados;
        turnoData[r.nombre_turno].sesiones += r.total_sesiones;
        turnoData[r.nombre_turno].pagadas += r.pagadas;
        turnoData[r.nombre_turno].pendientes += r.pendientes;
      });

      const turnos = Object.keys(turnoData);
      const ingresos = turnos.map(t => turnoData[t].ingresos);

      // Gr치fico 1: Ingresos
      const ctxIngresos = document.getElementById('chartIngresos').getContext('2d');
      if (chartIngresos) chartIngresos.destroy();
      chartIngresos = new Chart(ctxIngresos, {
        type: 'bar',
        data: {
          labels: turnos.map(t => t.charAt(0).toUpperCase() + t.slice(1)),
          datasets: [{
            label: 'Ingresos (S/)',
            data: ingresos,
            backgroundColor: ['rgba(37, 99, 235, 0.8)', 'rgba(5, 150, 105, 0.8)'],
            borderColor: ['#2563eb', '#059669'],
            borderWidth: 2,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      // Gr치fico 2: Distribuci칩n
      const ctxDist = document.getElementById('chartDistribucion').getContext('2d');
      if (chartDistribucion) chartDistribucion.destroy();
      chartDistribucion = new Chart(ctxDist, {
        type: 'doughnut',
        data: {
          labels: ['Pagadas', 'Pendientes'],
          datasets: [{
            data: [
              datosReporte.reduce((a, r) => a + r.pagadas, 0),
              datosReporte.reduce((a, r) => a + r.pendientes, 0)
            ],
            backgroundColor: ['#10b981', '#f59e0b'],
            borderColor: ['#fff', '#fff'],
            borderWidth: 3
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    function descargarPDF() {
      if (datosReporte.length === 0) {
        alert('Genera un reporte primero');
        return;
      }

      const element = document.querySelector('.container');
      const opt = {
        margin: 10,
        filename: `reporte_estacionamiento_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { orientation: 'landscape', unit: 'mm', format: 'a4' }
      };

      html2pdf().set(opt).from(element).save();
    }

    function descargarCSV() {
      if (datosReporte.length === 0) {
        alert('Genera un reporte primero');
        return;
      }

      const headers = ['Fecha', 'Turno', 'Sesiones', 'Pagadas', 'Pendientes', 'Activas', 'Ingresos Pagados', 'Ingresos Pendientes', 'Tiempo Promedio'];
      const rows = datosReporte.map(r => [
        r.fecha,
        r.nombre_turno,
        r.total_sesiones,
        r.pagadas,
        r.pendientes,
        r.activas,
        r.ingresos_pagados.toFixed(2),
        r.ingresos_pendientes.toFixed(2),
        r.tiempo_promedio
      ]);

      const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }
  </script>
</body>
</html>
